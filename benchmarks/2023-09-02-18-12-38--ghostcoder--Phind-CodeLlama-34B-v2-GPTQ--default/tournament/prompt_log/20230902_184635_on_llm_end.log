method: on_llm_end [2023-09-02 18:46:35]
llm_output: null
prompt:
In order to fix these issues, we need to modify our `tally` function so that it returns the expected output instead of printing it. We can do this by building a list of strings for each team's stats and then joining them into a single string before returning. Here is an updated version of the `tally` function which implements this change:

```python
def tally(rows):
    teams = {}

    # Process each row of data
    for row in rows:
        home_team, away_team, result = row.split(';')

        # Update stats for home team
        if home_team not in teams:
            teams[home_team] = {'MP': 0, 'W': 0, 'D': 0, 'L': 0, 'P': 0}

        teams[home_team]['MP'] += 1
        if result == 'win':
            teams[home_team]['W'] += 1
            teams[home_team]['P'] += 3
        elif result == 'draw':
            teams[home_team]['D'] += 1
            teams[home_team]['P'] += 1
        else: # It's a loss
            teams[home_team]['L'] += 1

        # Update stats for away team
        if away_team not in teams:
            teams[away_team] = {'MP': 0, 'W': 0, 'D': 0, 'L': 0, 'P': 0}

        teams[away_team]['MP'] += 1
        if result == 'loss':
            teams[away_team]['W'] += 1
            teams[away_team]['P'] += 3
        elif result == 'draw':
            teams[away_team]['D'] += 1
            teams[away_team]['P'] += 1
        else: # It's a win
            teams[away_team]['L'] += 1

    # Build the output string
    lines = ["Team                           | MP |  W |  D |  L |  P"]
    for team, stats in sorted(teams.items(), key=lambda x: (-x[1]['P'], x[0])):
        lines.append(f"{team:<32}| {stats['MP']:>2} | {stats['W']:>2} | {stats['D']:>2} | {stats['L']:>2} | {stats['P']:>2}")
    
    return '\n'.join(lines)
```
Now when you run your tests, they should pass because the `tally` function is correctly returning the expected results.
---
